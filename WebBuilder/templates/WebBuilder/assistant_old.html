{% extends 'WebBuilder/base.html' %}
{% load static %}

{% block body_class %}procesos{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="wb-assistant">

  <!-- Boton colapso -->
  <button class="wb-menu-toggle" id="menuToggle" aria-label="Toggle menu">
    
  </button>
  

  <!-- Navegaci√≥n lateral -->
  <aside class="wb-sidebar" id="sidebar">
    <div class="wb-sidebar__header">
      <!-- Logo ya est√° en navbar, aqu√≠ solo mantenemos padding -->
    </div>

    <nav class="wb-steps-nav">
      <button class="wb-step-nav" data-step="1" id="navStep1">
        <span class="wb-step-nav__number">1</span>
        <span class="wb-step-nav__text">Introducir URL</span>
      </button>
      <button class="wb-step-nav" data-step="2" id="navStep2">
        <span class="wb-step-nav__number">2</span>
        <span class="wb-step-nav__text">Configurar Mapping</span>
      </button>
      <button class="wb-step-nav" data-step="3" id="navStep3">
        <span class="wb-step-nav__number">3</span>
        <span class="wb-step-nav__text">Preview</span>
      </button>
      <button class="wb-step-nav" data-step="4" id="navStep4">
        <span class="wb-step-nav__number">4</span>
        <span class="wb-step-nav__text">Generar Web</span>
      </button>
    </nav>

    <div class="wb-sidebar__footer">
      <a href="{% url 'history' %}" class="wb-sidebar__link">Ver historial</a>
      <a href="{% url 'home' %}" class="wb-sidebar__link">Volver al inicio</a>
    </div>
  </aside>

  <!-- Contenido principal -->
  <main class="wb-main">
    
    <!-- Mensajes globales -->
    {% if messages %}
      <div class="wb-messages">
        {% for message in messages %}
          <div class="wb-message wb-message--{{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- PASO 1: Introducir URL -->
    <section class="wb-step" id="step1" data-step="1">
      <div class="wb-step__container">
        <div class="wb-step__header">
          <h1 class="wb-step__title">Paso 1: Introducir URL</h1>
          <p class="wb-step__description">
            Introduce la URL de una API que devuelva datos en formato JSON o XML. 
            Analizaremos su estructura autom√°ticamente.
          </p>
        </div>

        <div class="wb-step__content">
          <form method="post" class="wb-form" id="formStep1">
            {% csrf_token %}

            <div class="wb-form-group">
              <label class="wb-label" for="{{ form.api_url.id_for_label }}">
                URL de la API
              </label>
              <div class="wb-input-wrapper">
                {{ form.api_url }}
                {% if form.api_url.errors %}
                  <div class="wb-error">{{ form.api_url.errors }}</div>
                {% endif %}
              </div>
              <p class="wb-hint">Ejemplo: https://api.example.com/posts</p>
            </div>

            <div class="wb-actions">
              <button type="submit" class="wb-btn wb-btn--primary">
                Analizar URL
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- PASO 2: Configurar Mapping -->
    <section class="wb-step" id="step2" data-step="2" style="display: none;">
      <div class="wb-step__container">
        
        <!-- Alert de cach√© -->
        {% if messages %}
          <div class="wb-alert">
            <span class="wb-alert__icon">‚ö°</span>
            <div class="wb-alert__text">
              {% for message in messages %}
                {{ message }}
              {% endfor %}
            </div>
          </div>
        {% endif %}

        <div class="wb-step__header">
          <h1 class="wb-step__title">Paso 2: Configurar Mapping</h1>
          <p class="wb-step__description">
            Hemos analizado tu API. Ahora selecciona qu√© campo corresponde a cada elemento de tu web.
          </p>
        </div>

        {% if analysis %}
        <div class="wb-step__content">
          
          <!-- Resumen del An√°lisis - UNA TARJETA -->
          <div class="wb-analysis-card">
            <h3 class="wb-analysis-card__title">Resumen del An√°lisis</h3>
            
            {% if analysis.main_collection.found %}
            <div class="wb-analysis-info">
              <div class="wb-analysis-row">
                <span class="wb-analysis-row__label">Items encontrados</span>
                <span class="wb-analysis-row__value">{{ analysis.main_collection.count }}</span>
              </div>
              <div class="wb-analysis-row">
                <span class="wb-analysis-row__label">Formato detectado</span>
                <span class="wb-analysis-row__value">{{ api_request.response_summary|default:"JSON/XML" }}</span>
              </div>
              {% if analysis.main_collection.path %}
              <div class="wb-analysis-row">
                <span class="wb-analysis-row__label">Tipo de ra√≠z</span>
                <span class="wb-analysis-row__value">{{ analysis.main_collection.path }}</span>
              </div>
              {% endif %}
              <div class="wb-analysis-row">
                <span class="wb-analysis-row__label">Total elementos</span>
                <span class="wb-analysis-row__value">{{ analysis.main_collection.count }}</span>
              </div>
            </div>
            {% else %}
            <div class="wb-analysis-info">
              <div class="wb-analysis-row">
                <span class="wb-analysis-row__label">Estado</span>
                <span class="wb-analysis-row__value">{{ analysis.message|default:"No se encontraron items" }}</span>
              </div>
            </div>
            {% endif %}
          </div>

          <!-- Tipo de web (intenci√≥n) -->
          <div class="wb-intent-section">
            <h3 class="wb-section-title">¬øQu√© tipo de web quieres crear?</h3>
            <p class="wb-section-subtitle">
              Esto no limita tus datos: solo ordena los campos para que el mapping sea m√°s f√°cil.
            </p>

            <form method="post" class="wb-intent-grid" id="intentForm">
              {% csrf_token %}
              <input type="hidden" name="action" value="set_intent">
              {% if api_request %}
                <input type="hidden" name="api_request_id" value="{{ api_request.id }}">
              {% endif %}

              <button type="submit" name="intent" value="blog"
                      class="wb-intent-btn {% if mapping_intent == 'blog' %}is-active{% endif %}">
                <span class="wb-intent-title">Blog</span>
                <span class="wb-intent-desc">Entradas con fecha y contenido.</span>
              </button>

              <button type="submit" name="intent" value="portfolio"
                      class="wb-intent-btn {% if mapping_intent == 'portfolio' %}is-active{% endif %}">
                <span class="wb-intent-title">Portfolio</span>
                <span class="wb-intent-desc">Proyectos visuales con im√°genes.</span>
              </button>

              <button type="submit" name="intent" value="catalog"
                      class="wb-intent-btn {% if mapping_intent == 'catalog' %}is-active{% endif %}">
                <span class="wb-intent-title">Cat√°logo</span>
                <span class="wb-intent-desc">Productos con precio e imagen.</span>
              </button>

              <button type="submit" name="intent" value="directory"
                      class="wb-intent-btn {% if mapping_intent == 'directory' %}is-active{% endif %}">
                <span class="wb-intent-title">Directorio</span>
                <span class="wb-intent-desc">Listado con ficha y enlace.</span>
              </button>

              <button type="submit" name="intent" value="custom"
                      class="wb-intent-btn {% if mapping_intent == 'custom' %}is-active{% endif %}">
                <span class="wb-intent-title">Personalizado</span>
                <span class="wb-intent-desc">T√∫ decides todo.</span>
              </button>
            </form>

            <div class="wb-intent-current">
              Seleccionado: <strong>{{ intent_profile.label }}</strong> ‚Äî {{ intent_profile.description }}
            </div>
          </div>

          <!-- Wizard de mapping -->
          {% if analysis.main_collection.found %}
          <div class="wb-mapping-section">
            <h3 class="wb-section-title">Asignar Campos</h3>
            <p class="wb-section-subtitle">
              Selecciona el campo del dataset para cada rol. Deja "(ninguno)" si no aplica.
            </p>

            <form method="post" class="wb-form" id="formStep2">
              {% csrf_token %}
              <input type="hidden" name="action" value="save_mapping">
              {% if api_request %}
                <input type="hidden" name="api_request_id" value="{{ api_request.id }}">
              {% endif %}

              {% if role_options %}
                <!-- Imprescindible -->
                <div class="wb-mapping-category">
                  <h4 class="wb-mapping-category__title">Imprescindible</h4>
                  {% for r in role_options %}
                    {% if r.section == "required" %}
                      <div class="wb-mapping-row">
                        <label class="wb-label">
                          {% if r.has_suggestion %}<span class="wb-label-star">‚≠ê</span>{% endif %}
                          {{ r.label }}
                        </label>
                        {% if r.help %}<div class="wb-hint">{{ r.help }}</div>{% endif %}

                        <select class="wb-select" name="map_{{ r.role }}">
                          <option value="" {% if r.none_selected %}selected{% endif %}>(ninguno)</option>
                          {% for opt in r.options %}
                            <option value="{{ opt.key }}"
                                    {% if opt.is_selected %}selected{% endif %}
                                    {% if opt.is_suggested %}class="wb-suggested-option"{% endif %}>
                              {{ opt.key }}{% if opt.is_suggested %} ‚≠ê{% endif %}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>

                <!-- Recomendado -->
                <div class="wb-mapping-category">
                  <h4 class="wb-mapping-category__title">Recomendado</h4>
                  {% for r in role_options %}
                    {% if r.section == "recommended" %}
                      <div class="wb-mapping-row">
                        <label class="wb-label">
                          {% if r.has_suggestion %}<span class="wb-label-star">‚≠ê</span>{% endif %}
                          {{ r.label }}
                        </label>
                        {% if r.help %}<div class="wb-hint">{{ r.help }}</div>{% endif %}

                        <select class="wb-select" name="map_{{ r.role }}">
                          <option value="" {% if r.none_selected %}selected{% endif %}>(ninguno)</option>
                          {% for opt in r.options %}
                            <option value="{{ opt.key }}"
                                    {% if opt.is_selected %}selected{% endif %}
                                    {% if opt.is_suggested %}class="wb-suggested-option"{% endif %}>
                              {{ opt.key }}{% if opt.is_suggested %} ‚≠ê{% endif %}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>

                <!-- Opcional -->
                <div class="wb-mapping-category">
                  <h4 class="wb-mapping-category__title">Opcional</h4>
                  {% for r in role_options %}
                    {% if r.section == "optional" or r.section == "other" %}
                      <div class="wb-mapping-row">
                        <label class="wb-label">
                          {% if r.has_suggestion %}<span class="wb-label-star">‚≠ê</span>{% endif %}
                          {{ r.label }}
                        </label>
                        {% if r.help %}<div class="wb-hint">{{ r.help }}</div>{% endif %}

                        <select class="wb-select" name="map_{{ r.role }}">
                          <option value="" {% if r.none_selected %}selected{% endif %}>(ninguno)</option>
                          {% for opt in r.options %}
                            <option value="{{ opt.key }}"
                                    {% if opt.is_selected %}selected{% endif %}
                                    {% if opt.is_suggested %}class="wb-suggested-option"{% endif %}>
                              {{ opt.key }}{% if opt.is_suggested %} ‚≠ê{% endif %}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}

              <div class="wb-actions">
                <button type="button" class="wb-btn wb-btn--secondary" onclick="goToStep(1)">
                  Volver
                </button>
                <button type="submit" class="wb-btn wb-btn--primary">
                  Continuar
                </button>
              </div>
            </form>
          </div>
          {% endif %}

        </div>
        {% endif %}
      </div>
    </section>

    <!-- PASO 3: Preview -->
    <section class="wb-step" id="step3" data-step="3" style="display: none;">
      <div class="wb-step__container">
        <div class="wb-step__header">
          <h1 class="wb-step__title">Paso 3: Preview</h1>
          <p class="wb-step__description">
            Visualiza c√≥mo se ver√°n tus datos y personaliza el dise√±o antes de generar tu web.
          </p>
        </div>

        <div class="wb-preview-layout">
          <!-- PANEL IZQUIERDO: Controles -->
          <div class="wb-controls-panel">
            <h3 class="wb-controls-panel__title">Personalizar</h3>

            <!-- Tipo de Layout -->
            <div class="wb-control-group">
              <div class="wb-control-label">
                <span class="wb-control-label__icon">üìê</span>
                Tipo de Layout
              </div>
              <div class="wb-layout-selector">
                <div class="wb-layout-option active" data-layout="card">
                  <div class="wb-layout-option__radio"></div>
                  <span class="wb-layout-option__label">Card</span>
                </div>
                <div class="wb-layout-option" data-layout="list">
                  <div class="wb-layout-option__radio"></div>
                  <span class="wb-layout-option__label">Lista Compacta</span>
                </div>
                <div class="wb-layout-option" data-layout="timeline">
                  <div class="wb-layout-option__radio"></div>
                  <span class="wb-layout-option__label">Timeline</span>
                </div>
              </div>
            </div>

            <!-- Color Primario -->
            <div class="wb-control-group">
              <div class="wb-control-label">
                <span class="wb-control-label__icon">üé®</span>
                Color Primario
              </div>
              <div class="wb-color-picker">
                <button class="wb-color-option active" data-color="#3b82f6" style="background: #3b82f6;" aria-label="Azul"></button>
                <button class="wb-color-option" data-color="#8b5cf6" style="background: #8b5cf6;" aria-label="Morado"></button>
                <button class="wb-color-option" data-color="#10b981" style="background: #10b981;" aria-label="Verde"></button>
                <button class="wb-color-option" data-color="#ef4444" style="background: #ef4444;" aria-label="Rojo"></button>
                <button class="wb-color-option" data-color="#f59e0b" style="background: #f59e0b;" aria-label="Naranja"></button>
                <button class="wb-color-option" data-color="#ec4899" style="background: #ec4899;" aria-label="Rosa"></button>
              </div>
            </div>

            <!-- Tama√±o de Fuente -->
            <div class="wb-control-group">
              <div class="wb-control-label">
                <span class="wb-control-label__icon">üî§</span>
                Tama√±o de Fuente
              </div>
              <div class="wb-slider-container">
                <input type="range" class="wb-slider" id="fontSizeSlider" min="0.8" max="1.3" step="0.1" value="1">
                <div class="wb-slider-labels">
                  <span>Peque√±o</span>
                  <span>Grande</span>
                </div>
              </div>
            </div>

            <!-- Campos Visibles -->
            <div class="wb-control-group">
              <div class="wb-control-label">
                <span class="wb-control-label__icon">üëÅÔ∏è</span>
                Campos Visibles
              </div>
              <div class="wb-field-toggles">
                <div class="wb-field-toggle">
                  <input type="checkbox" id="field-title" checked disabled>
                  <label for="field-title">T√≠tulo</label>
                </div>
                <div class="wb-field-toggle">
                  <input type="checkbox" id="field-description" checked>
                  <label for="field-description">Descripci√≥n</label>
                </div>
                <div class="wb-field-toggle">
                  <input type="checkbox" id="field-image">
                  <label for="field-image">Imagen</label>
                </div>
                <div class="wb-field-toggle">
                  <input type="checkbox" id="field-date" checked>
                  <label for="field-date">Fecha</label>
                </div>
                <div class="wb-field-toggle">
                  <input type="checkbox" id="field-author" checked>
                  <label for="field-author">Autor</label>
                </div>
              </div>
            </div>
          </div>

          <!-- PANEL DERECHO: Preview -->
          <div class="wb-preview-panel">
            <div class="wb-preview-header">
              <h3 class="wb-preview-title">Vista Previa</h3>
            </div>

            <div class="wb-preview-container" id="previewContainer">
              <!-- CARDS (por defecto) -->
              <div class="wb-preview-items" id="cardLayout">
                <div class="wb-card">
                  <div class="wb-card__content">
                    <h3 class="wb-card__title">The Future of Web Development</h3>
                    <p class="wb-card__description" data-field="description">
                      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                    </p>
                    <div class="wb-card__meta">
                      <span class="wb-card__meta-item" data-field="date">üìÖ 12 Feb 2026</span>
                      <span class="wb-card__meta-item" data-field="author">üë§ John Doe</span>
                    </div>
                  </div>
                </div>

                <div class="wb-card">
                  <div class="wb-card__content">
                    <h3 class="wb-card__title">Django Best Practices</h3>
                    <p class="wb-card__description" data-field="description">
                      Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </p>
                    <div class="wb-card__meta">
                      <span class="wb-card__meta-item" data-field="date">üìÖ 11 Feb 2026</span>
                      <span class="wb-card__meta-item" data-field="author">üë§ Jane Smith</span>
                    </div>
                  </div>
                </div>

                <div class="wb-card">
                  <div class="wb-card__content">
                    <h3 class="wb-card__title">API Design Patterns</h3>
                    <p class="wb-card__description" data-field="description">
                      Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                    </p>
                    <div class="wb-card__meta">
                      <span class="wb-card__meta-item" data-field="date">üìÖ 10 Feb 2026</span>
                      <span class="wb-card__meta-item" data-field="author">üë§ Mike Johnson</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- LISTA COMPACTA (oculta por defecto) -->
              <div class="wb-preview-items wb-preview-hidden" id="listLayout">
                <div class="wb-list-item">
                  <div class="wb-list-item__icon">1</div>
                  <div class="wb-list-item__content">
                    <h3 class="wb-list-item__title">The Future of Web Development</h3>
                    <p class="wb-list-item__description" data-field="description">
                      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                    </p>
                    <div class="wb-list-item__meta">
                      <span data-field="date">üìÖ 12 Feb 2026</span>
                      <span data-field="author">üë§ John Doe</span>
                    </div>
                  </div>
                </div>

                <div class="wb-list-item">
                  <div class="wb-list-item__icon">2</div>
                  <div class="wb-list-item__content">
                    <h3 class="wb-list-item__title">Django Best Practices</h3>
                    <p class="wb-list-item__description" data-field="description">
                      Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </p>
                    <div class="wb-list-item__meta">
                      <span data-field="date">üìÖ 11 Feb 2026</span>
                      <span data-field="author">üë§ Jane Smith</span>
                    </div>
                  </div>
                </div>

                <div class="wb-list-item">
                  <div class="wb-list-item__icon">3</div>
                  <div class="wb-list-item__content">
                    <h3 class="wb-list-item__title">API Design Patterns</h3>
                    <p class="wb-list-item__description" data-field="description">
                      Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                    </p>
                    <div class="wb-list-item__meta">
                      <span data-field="date">üìÖ 10 Feb 2026</span>
                      <span data-field="author">üë§ Mike Johnson</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- TIMELINE (oculta por defecto) -->
              <div class="wb-timeline wb-preview-hidden" id="timelineLayout">
                <div class="wb-timeline-item">
                  <div class="wb-timeline-item__date" data-field="date">12 Feb 2026</div>
                  <div class="wb-timeline-item__content">
                    <h3 class="wb-timeline-item__title">The Future of Web Development</h3>
                    <p class="wb-timeline-item__description" data-field="description">
                      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.
                    </p>
                    <div class="wb-timeline-item__meta" data-field="author">üë§ John Doe</div>
                  </div>
                </div>

                <div class="wb-timeline-item">
                  <div class="wb-timeline-item__date" data-field="date">11 Feb 2026</div>
                  <div class="wb-timeline-item__content">
                    <h3 class="wb-timeline-item__title">Django Best Practices</h3>
                    <p class="wb-timeline-item__description" data-field="description">
                      Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
                    </p>
                    <div class="wb-timeline-item__meta" data-field="author">üë§ Jane Smith</div>
                  </div>
                </div>

                <div class="wb-timeline-item">
                  <div class="wb-timeline-item__date" data-field="date">10 Feb 2026</div>
                  <div class="wb-timeline-item__content">
                    <h3 class="wb-timeline-item__title">API Design Patterns</h3>
                    <p class="wb-timeline-item__description" data-field="description">
                      Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur.
                    </p>
                    <div class="wb-timeline-item__meta" data-field="author">üë§ Mike Johnson</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="wb-actions">
          <button type="button" class="wb-btn wb-btn--secondary" onclick="goToStep(2)">
            Volver
          </button>
          <button type="button" class="wb-btn wb-btn--primary" onclick="confirmMapping()">
            Confirmar y Generar
          </button>
        </div>
      </div>
    </section>

    <!-- PASO 4: Generar Web (Placeholder) -->
    <section class="wb-step" id="step4" data-step="4" style="display: none;">
      <div class="wb-step__container">
        <div class="wb-step__header">
          <h1 class="wb-step__title">Paso 4: Generar Web</h1>
          <p class="wb-step__description">
            Pr√≥ximamente: Generaci√≥n autom√°tica de tu sitio web.
          </p>
        </div>

        <div class="wb-step__content">
          <div class="wb-placeholder">
            <div class="wb-placeholder__icon">üöß</div>
            <h3 class="wb-placeholder__title">En desarrollo</h3>
            <p class="wb-placeholder__text">
              Esta funcionalidad estar√° disponible pr√≥ximamente. 
              Aqu√≠ podr√°s generar y descargar tu sitio web completo.
            </p>
          </div>

          <div class="wb-actions">
            <button type="button" class="wb-btn wb-btn--secondary" onclick="goToStep(3)">
              Volver
            </button>
            <a href="{% url 'history' %}" class="wb-btn wb-btn--primary">
              Ver Historial
            </a>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Overlay de transici√≥n con l√≠nea de progreso -->
  <div class="wb-transition-overlay" id="transitionOverlay">
    <div class="wb-progress-bar">
      <div class="wb-progress-bar__fill" id="progressBarFill"></div>
    </div>
    <p class="wb-transition-text" id="transitionText">Cargando...</p>
  </div>

</div>

<!-- JavaScript externo -->
<script src="{% static 'js/assistant.js' %}"></script>

<!-- Inicializaci√≥n con datos de Django -->
<script>
  // Datos iniciales del servidor (Django template variables)
  const initialData = {
    analysisData: null,
    initialStep: 1,
    assistantUrl: '{% url "assistant" %}',
    debug: false  // Cambiar a true para ver logs en consola
  };

  {% if api_request %}
  initialData.analysisData = {
    id: {{ api_request.id }},
    hasAnalysis: {% if analysis %}true{% else %}false{% endif %}
  };
  
  {% if analysis and analysis.main_collection.found %}
  initialData.initialStep = 2;
  {% endif %}
  {% endif %}

  // Inicializar cuando el DOM est√© listo
  document.addEventListener('DOMContentLoaded', () => {
    initAssistant(initialData);
  });
</script>

{% endblock %}
