{% extends 'WebBuilder/base.html' %}
{% load static %}

{% block body_class %}preview{% endblock %}

{% block content %}
<div class="wb-container">

  <header class="wb-header">
    <h1 class="wb-title">Preview</h1>
    <p class="wb-subtitle">Vista previa de los items normalizados a un est√°ndar interno</p>
  </header>

  {% if messages %}
    <div class="wb-messages">
      {% for message in messages %}
        <div class="wb-message wb-message--{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <section class="wb-card">
    <h2 class="wb-card__title">Informaci√≥n</h2>

    <div class="wb-kv">
      <div class="wb-kv__item wb-kv__item--full">
        <span class="wb-kv__k">URL</span>
        <span class="wb-kv__v wb-mono">{{ api_request.api_url }}</span>
      </div>

      <div class="wb-kv__item">
        <span class="wb-kv__k">Estado</span>
        <span class="wb-kv__v">{{ api_request.status }}</span>
      </div>

      <div class="wb-kv__item">
        <span class="wb-kv__k">APIRequest</span>
        <span class="wb-kv__v">#{{ api_request.id }}</span>
      </div>
    </div>

    <div class="wb-actions">
      <a class="wb-btn wb-btn--secondary" href="{% url 'assistant' %}?api_request_id={{ api_request.id }}">
        ‚Üê Volver al asistente (este an√°lisis)
      </a>
      <a class="wb-btn wb-btn--secondary" href="{% url 'assistant' %}">
        Volver al asistente
      </a>
      <a class="wb-btn wb-btn--secondary" href="{% url 'history' %}">
        Ir al historial
      </a>
    </div>
  </section>

  <section class="wb-card">
    <h2 class="wb-card__title">Items</h2>
    <p class="wb-hint">Si sale vac√≠o, revisa el mapping y/o la colecci√≥n principal detectada.</p>

    <div class="wb-divider"></div>

    <!-- Debug (puedes quitarlo cuando quieras) -->
    <div class="wb-kv" style="margin-bottom:12px;">
      <div class="wb-kv__item">
        <span class="wb-kv__k">Colecci√≥n detectada</span>
        <span class="wb-kv__v">{{ analysis.main_collection.found }}</span>
      </div>
      <div class="wb-kv__item">
        <span class="wb-kv__k">Path</span>
        <span class="wb-kv__v wb-mono">{{ analysis.main_collection.path_display }}</span>
      </div>
      <div class="wb-kv__item">
        <span class="wb-kv__k">Count</span>
        <span class="wb-kv__v">{{ analysis.main_collection.count }}</span>
      </div>
    </div>
    <!-- /Debug -->

    {% if items %}
      <div class="wb-preview-grid">
        {% for it in items %}
          <div class="wb-preview-item">
            {% if it.image %}
              <img src="{{ it.image }}" alt="{{ it.title }}" class="wb-preview-item__image">
            {% else %}
              <div class="wb-preview-item__image" style="display:flex;align-items:center;justify-content:center;background:#1a1a1a;">
                <span style="font-size:3rem;opacity:0.3;">üìÑ</span>
              </div>
            {% endif %}

            <div class="wb-preview-item__content">
              <h3 class="wb-preview-item__title">{{ it.title|default:"(Sin t√≠tulo)"|truncatewords:10 }}</h3>

              {% if it.description %}
                <p class="wb-preview-item__description">{{ it.description|truncatewords:20 }}</p>
              {% endif %}

              {% if it.link %}
                <a href="{{ it.link }}" class="wb-preview-item__link" target="_blank" rel="noopener">
                  Ver m√°s ‚Üí
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="wb-muted">
        No se han podido extraer items normalizados. Revisa el mapping y/o el path de la colecci√≥n principal.
      </p>
    {% endif %}

  </section>

</div>
{% endblock %}
