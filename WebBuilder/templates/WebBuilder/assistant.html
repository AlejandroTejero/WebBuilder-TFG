{% extends 'WebBuilder/base.html' %}
{% load static %}

{% block body_class %}procesos{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="wb-assistant">
  <main class="wb-main">

    <!-- Mensajes globales -->
    {% if messages %}
      <div class="wb-messages">
        {% for message in messages %}
          <div class="wb-message wb-message--{{ message.tags }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- ÚNICO PASO: Introducir URL -->
    <section class="wb-step" id="step1" data-step="1">
      <div class="wb-step__container">
        <div class="wb-step__header">
          <h1 class="wb-step__title">Analizar URL</h1>
          <p class="wb-step__description">
            Introduce la URL de una API que devuelva datos en formato JSON o XML.
            Guardaremos el resultado y mostraremos un resumen del análisis.
          </p>
        </div>

        <div class="wb-step__content">
          <form method="post" class="wb-form">
            {% csrf_token %}

            <div class="wb-form-group">
              <label class="wb-label" for="{{ form.api_url.id_for_label }}">
                URL de la API
              </label>
              <div class="wb-input-wrapper">
                {{ form.api_url }}
                {% if form.api_url.errors %}
                  <div class="wb-error">{{ form.api_url.errors }}</div>
                {% endif %}
              </div>
              <p class="wb-hint">
                Ejemplo JSON: https://jsonplaceholder.typicode.com/posts<br>
                Ejemplo XML: https://www.w3schools.com/xml/plant_catalog.xml
              </p>
            </div>

            <!-- ✅ Nuevo campo: Prompt del usuario (LLM) -->
            <div class="wb-form-group">
              <label class="wb-label" for="{{ form.user_prompt.id_for_label }}">
                Prompt del usuario (opcional)
              </label>
              <div class="wb-input-wrapper">
                {{ form.user_prompt }}
                {% if form.user_prompt.errors %}
                  <div class="wb-error">{{ form.user_prompt.errors }}</div>
                {% endif %}
              </div>
              <p class="wb-hint">
                Ejemplo: "Quiero un portfolio minimalista con 3 secciones (inicio, proyectos, contacto) y que muestre imágenes y fechas."
              </p>
            </div>

            <div class="wb-actions">
              <button type="submit" class="wb-btn wb-btn--primary">
                Analizar
              </button>
              <a href="{% url 'history' %}" class="wb-btn wb-btn--secondary">
                Ver historial
              </a>
              <a href="{% url 'home' %}" class="wb-btn wb-btn--secondary">
                Volver al inicio
              </a>
            </div>
          </form>
        </div>
      </div>
    </section>

    <br>
    
    <!-- Resultado del análisis -->
    {% if analysis %}
    <section class="wb-step" id="analysisResult">
      <div class="wb-step__container">
        <div class="wb-step__header">
          <h2 class="wb-step__title">Resultado del análisis</h2>
          <p class="wb-step__description">
            Esto es lo que detectamos de tu dataset. El siguiente paso será pedir al LLM que sugiera el mapping.
          </p>
        </div>

        <div class="wb-step__content">
          <div class="wb-analysis-card">
            <h3 class="wb-analysis-card__title">Resumen</h3>

            {% if analysis.main_collection.found %}
              <div class="wb-analysis-info">
                <div class="wb-analysis-row">
                  <span class="wb-analysis-row__label">Items encontrados</span>
                  <span class="wb-analysis-row__value">{{ analysis.main_collection.count }}</span>
                </div>

                <div class="wb-analysis-row">
                  <span class="wb-analysis-row__label">Formato detectado</span>
                  <span class="wb-analysis-row__value">{{ api_request.response_summary|default:"JSON/XML" }}</span>
                </div>

                {% if analysis.main_collection.path %}
                <div class="wb-analysis-row">
                  <span class="wb-analysis-row__label">Ruta colección principal</span>
                  <span class="wb-analysis-row__value">{{ analysis.main_collection.path }}</span>
                </div>
                {% endif %}
              </div>
            {% else %}
              <div class="wb-analysis-info">
                <div class="wb-analysis-row">
                  <span class="wb-analysis-row__label">Estado</span>
                  <span class="wb-analysis-row__value">
                    {{ analysis.message|default:"No se encontraron items" }}
                  </span>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </section>
    {% endif %}

    {% if llm_reply %}
      <h3>Respuesta del LLM</h3>
      <pre style="white-space: pre-wrap;">{{ llm_reply }}</pre>
    {% endif %}

    {% if llm_error %}
      <div class="alert alert-danger">Error LLM: {{ llm_error }}</div>
    {% endif %}

  </main>
</div>
{% endblock %}